<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å­¦æœ¯èµ„æºåº“ - æ–‡ä»¶ç®¡ç†å™¨ - MySite</title>
    <link rel="stylesheet" href="/light.css">
    <link rel="stylesheet" href="/dark.css" id="dark-css" disabled>
    <style>
        .file-manager {
            display: flex;
            height: calc(100vh - 60px);
            background: var(--bg-color);
        }
        
        /* ä¾§è¾¹æ  */
        .sidebar {
            width: 300px;
            background: var(--card-bg);
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
        }
        
        .sidebar-header {
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .sidebar-title {
            font-size: 1.2rem;
            font-weight: bold;
            color: var(--text-color);
            margin-bottom: 15px;
        }
        
        .search-box {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            background: var(--bg-color);
            color: var(--text-color);
        }
        
        .folder-tree {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
        }
        
        .folder-item {
            display: flex;
            align-items: center;
            padding: 8px 12px;
            margin: 2px 0;
            border-radius: 4px;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .folder-item:hover {
            background: var(--hover-bg);
        }
        
        .folder-item.active {
            background: var(--primary-color);
            color: white;
        }
        
        .folder-icon {
            width: 16px;
            height: 16px;
            margin-right: 8px;
            color: var(--primary-color);
        }
        
        .folder-item.active .folder-icon {
            color: white;
        }
        
        .folder-name {
            flex: 1;
            font-size: 0.9rem;
        }
        
        .folder-actions {
            display: none;
            gap: 5px;
        }
        
        .folder-item:hover .folder-actions {
            display: flex;
        }
        
        .btn-icon {
            width: 20px;
            height: 20px;
            border: none;
            background: none;
            cursor: pointer;
            border-radius: 2px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-muted);
        }
        
        .btn-icon:hover {
            background: var(--hover-bg);
            color: var(--text-color);
        }
        
        /* ä¸»å†…å®¹åŒº */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        
        .toolbar {
            padding: 15px 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            gap: 15px;
            background: var(--card-bg);
        }
        
        .breadcrumb {
            flex: 1;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .breadcrumb-item {
            color: var(--text-muted);
            cursor: pointer;
        }
        
        .breadcrumb-item:hover {
            color: var(--text-color);
        }
        
        .breadcrumb-separator {
            color: var(--text-muted);
        }
        
        .toolbar-actions {
            display: flex;
            gap: 10px;
        }
        
        .btn {
            padding: 8px 16px;
            border: 1px solid var(--border-color);
            background: var(--bg-color);
            color: var(--text-color);
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s;
        }
        
        .btn:hover {
            background: var(--hover-bg);
        }
        
        .btn-primary {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }
        
        .btn-primary:hover {
            background: var(--primary-hover);
        }
        
        /* æ–‡ä»¶åˆ—è¡¨ */
        .file-list {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }
        
        .file-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 20px;
        }
        
        .file-item {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }
        
        .file-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .file-icon {
            width: 40px;
            height: 40px;
            margin: 0 auto 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--primary-color);
            color: white;
            border-radius: 8px;
            font-size: 1.2rem;
        }
        
        .file-name {
            font-weight: 500;
            color: var(--text-color);
            margin-bottom: 5px;
            word-break: break-word;
        }
        
        .file-meta {
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-bottom: 10px;
        }
        
        .file-actions {
            display: none;
            position: absolute;
            top: 10px;
            right: 10px;
            gap: 5px;
        }
        
        .file-item:hover .file-actions {
            display: flex;
        }
        
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-muted);
        }
        
        .empty-state h3 {
            margin-bottom: 10px;
            color: var(--text-color);
        }
        
        /* æ¨¡æ€æ¡† */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        
        .modal-content {
            background-color: var(--bg-color);
            margin: 2% auto;
            padding: 20px;
            border-radius: 8px;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .modal-title {
            font-size: 1.3rem;
            font-weight: bold;
            color: var(--text-color);
        }
        
        .close {
            color: var(--text-muted);
            font-size: 24px;
            font-weight: bold;
            cursor: pointer;
        }
        
        .close:hover {
            color: var(--text-color);
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: var(--text-color);
        }
        
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            background: var(--bg-color);
            color: var(--text-color);
        }
        
        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }
        
        .form-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 20px;
        }
        
        .btn-secondary {
            background: var(--text-muted);
            color: white;
            border: none;
        }
        
        .btn-secondary:hover {
            background: var(--text-color);
        }
        
        /* å“åº”å¼ */
        @media (max-width: 768px) {
            .file-manager {
                flex-direction: column;
                height: auto;
            }
            
            .sidebar {
                width: 100%;
                height: 200px;
            }
            
            .file-grid {
                grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
                gap: 15px;
            }
        }
    </style>
</head>
<body>
    <div class="file-manager">
        <!-- ä¾§è¾¹æ  -->
        <div class="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-title">ğŸ“ æ–‡ä»¶å¤¹</div>
                <input type="text" class="search-box" id="folderSearch" placeholder="æœç´¢æ–‡ä»¶å¤¹...">
            </div>
            <div class="folder-tree" id="folderTree">
                <div class="loading">åŠ è½½ä¸­...</div>
            </div>
        </div>
        
        <!-- ä¸»å†…å®¹åŒº -->
        <div class="main-content">
            <!-- å·¥å…·æ  -->
            <div class="toolbar">
                <div class="breadcrumb" id="breadcrumb">
                    <span class="breadcrumb-item" onclick="navigateToFolder(null)">ğŸ“ æˆ‘çš„æ–‡çŒ®</span>
                </div>
                <div class="toolbar-actions">
                    <button class="btn" onclick="openCreateFolderModal()">ğŸ“ æ–°å»ºæ–‡ä»¶å¤¹</button>
                    <button class="btn" onclick="openCreateCategoryModal()">ğŸ·ï¸ æ–°å»ºåˆ†ç±»</button>
                    <button class="btn btn-primary" onclick="openAddResourceModal()">ğŸ“„ æ·»åŠ æ–‡çŒ®</button>
                </div>
            </div>
            
            <!-- æ–‡ä»¶åˆ—è¡¨ -->
            <div class="file-list">
                <div class="file-grid" id="fileGrid">
                    <div class="loading">åŠ è½½ä¸­...</div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- åˆ›å»ºæ–‡ä»¶å¤¹æ¨¡æ€æ¡† -->
    <div id="createFolderModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">åˆ›å»ºæ–‡ä»¶å¤¹</h2>
                <span class="close" onclick="closeModal('createFolderModal')">&times;</span>
            </div>
            <form id="createFolderForm">
                <div class="form-group">
                    <label for="folderName">æ–‡ä»¶å¤¹åç§° *</label>
                    <input type="text" id="folderName" name="name" required>
                </div>
                <div class="form-group">
                    <label for="folderDescription">æè¿°</label>
                    <textarea id="folderDescription" name="description"></textarea>
                </div>
                <div class="form-group">
                    <label for="folderColor">é¢œè‰²</label>
                    <input type="color" id="folderColor" name="color" value="#007bff">
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('createFolderModal')">å–æ¶ˆ</button>
                    <button type="submit" class="btn btn-primary">åˆ›å»º</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- åˆ›å»ºåˆ†ç±»æ¨¡æ€æ¡† -->
    <div id="createCategoryModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">åˆ›å»ºåˆ†ç±»</h2>
                <span class="close" onclick="closeModal('createCategoryModal')">&times;</span>
            </div>
            <form id="createCategoryForm">
                <div class="form-group">
                    <label for="categoryName">åˆ†ç±»åç§° *</label>
                    <input type="text" id="categoryName" name="name" required>
                </div>
                <div class="form-group">
                    <label for="categoryDescription">æè¿°</label>
                    <textarea id="categoryDescription" name="description"></textarea>
                </div>
                <div class="form-group">
                    <label for="categoryColor">é¢œè‰²</label>
                    <input type="color" id="categoryColor" name="color" value="#6c757d">
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('createCategoryModal')">å–æ¶ˆ</button>
                    <button type="submit" class="btn btn-primary">åˆ›å»º</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- æ·»åŠ æ–‡çŒ®æ¨¡æ€æ¡† -->
    <div id="addResourceModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">æ·»åŠ æ–‡çŒ®</h2>
                <span class="close" onclick="closeModal('addResourceModal')">&times;</span>
            </div>
            <form id="addResourceForm" enctype="multipart/form-data">
                <div class="form-group">
                    <label for="resourceTitle">æ ‡é¢˜ *</label>
                    <input type="text" id="resourceTitle" name="title" required>
                </div>
                <div class="form-group">
                    <label for="resourceAuthors">ä½œè€…</label>
                    <input type="text" id="resourceAuthors" name="authors" placeholder="å¤šä¸ªä½œè€…ç”¨é€—å·åˆ†éš”">
                </div>
                <div class="form-group">
                    <label for="resourceFolder">æ–‡ä»¶å¤¹</label>
                    <select id="resourceFolder" name="folder_id">
                        <option value="">é€‰æ‹©æ–‡ä»¶å¤¹</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="resourceCategory">åˆ†ç±»</label>
                    <select id="resourceCategory" name="user_category_id">
                        <option value="">é€‰æ‹©åˆ†ç±»</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="resourceFile">æ–‡ä»¶</label>
                    <input type="file" id="resourceFile" name="file" accept=".pdf,.doc,.docx,.txt">
                </div>
                <div class="form-group">
                    <label for="resourceAbstract">æ‘˜è¦</label>
                    <textarea id="resourceAbstract" name="abstract"></textarea>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('addResourceModal')">å–æ¶ˆ</button>
                    <button type="submit" class="btn btn-primary">æ·»åŠ </button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- ç¼–è¾‘æ–‡ä»¶å¤¹æ¨¡æ€æ¡† -->
    <div id="editFolderModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">ç¼–è¾‘æ–‡ä»¶å¤¹</h2>
                <span class="close" onclick="closeModal('editFolderModal')">&times;</span>
            </div>
            <form id="editFolderForm">
                <input type="hidden" id="editFolderId" name="id">
                <div class="form-group">
                    <label for="editFolderName">æ–‡ä»¶å¤¹åç§° *</label>
                    <input type="text" id="editFolderName" name="name" required>
                </div>
                <div class="form-group">
                    <label for="editFolderDescription">æè¿°</label>
                    <textarea id="editFolderDescription" name="description"></textarea>
                </div>
                <div class="form-group">
                    <label for="editFolderColor">é¢œè‰²</label>
                    <input type="color" id="editFolderColor" name="color" value="#007bff">
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('editFolderModal')">å–æ¶ˆ</button>
                    <button type="submit" class="btn btn-primary">ä¿å­˜</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- ç¼–è¾‘æ–‡çŒ®æ¨¡æ€æ¡† -->
    <div id="editResourceModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">ç¼–è¾‘æ–‡çŒ®</h2>
                <span class="close" onclick="closeModal('editResourceModal')">&times;</span>
            </div>
            <form id="editResourceForm">
                <input type="hidden" id="editResourceId" name="id">
                <div class="form-group">
                    <label for="editResourceTitle">æ ‡é¢˜ *</label>
                    <input type="text" id="editResourceTitle" name="title" required>
                </div>
                <div class="form-group">
                    <label for="editResourceAuthors">ä½œè€…</label>
                    <input type="text" id="editResourceAuthors" name="authors" placeholder="å¤šä¸ªä½œè€…ç”¨é€—å·åˆ†éš”">
                </div>
                <div class="form-group">
                    <label for="editResourceFolder">æ–‡ä»¶å¤¹</label>
                    <select id="editResourceFolder" name="folder_id">
                        <option value="">é€‰æ‹©æ–‡ä»¶å¤¹</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="editResourceCategory">åˆ†ç±»</label>
                    <select id="editResourceCategory" name="user_category_id">
                        <option value="">é€‰æ‹©åˆ†ç±»</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="editResourceSubject">å­¦ç§‘</label>
                    <input type="text" id="editResourceSubject" name="subject" placeholder="å­¦ç§‘åˆ†ç±»">
                </div>
                <div class="form-group">
                    <label for="editResourceYear">å‘è¡¨å¹´ä»½</label>
                    <input type="number" id="editResourceYear" name="publication_year" min="1900" max="2030">
                </div>
                <div class="form-group">
                    <label for="editResourceKeywords">å…³é”®è¯</label>
                    <input type="text" id="editResourceKeywords" name="keywords" placeholder="å¤šä¸ªå…³é”®è¯ç”¨é€—å·åˆ†éš”">
                </div>
                <div class="form-group">
                    <label for="editResourceStatus">é˜…è¯»çŠ¶æ€</label>
                    <select id="editResourceStatus" name="reading_status">
                        <option value="unread">æœªè¯»</option>
                        <option value="reading">é˜…è¯»ä¸­</option>
                        <option value="completed">å·²å®Œæˆ</option>
                        <option value="reviewing">å¤ä¹ ä¸­</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="editResourceAbstract">æ‘˜è¦</label>
                    <textarea id="editResourceAbstract" name="abstract" rows="4"></textarea>
                </div>
                <div class="form-group">
                    <label for="editResourceNotes">ä¸ªäººç¬”è®°</label>
                    <textarea id="editResourceNotes" name="notes" rows="3"></textarea>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('editResourceModal')">å–æ¶ˆ</button>
                    <button type="submit" class="btn btn-primary">ä¿å­˜</button>
                </div>
            </form>
        </div>
    </div>
    
    <script src="/theme.js"></script>
    <script>
        // å…¨å±€å˜é‡
        let currentFolderId = null;
        let folders = [];
        let categories = [];
        
        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            loadFolderTree();
            loadCategories();
            loadResources();
            setupEventListeners();
        });
        
        // è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
        function setupEventListeners() {
            // æ–‡ä»¶å¤¹æœç´¢
            document.getElementById('folderSearch').addEventListener('input', filterFolders);
            
            // è¡¨å•æäº¤
            document.getElementById('createFolderForm').addEventListener('submit', handleCreateFolder);
            document.getElementById('editFolderForm').addEventListener('submit', handleEditFolder);
            document.getElementById('createCategoryForm').addEventListener('submit', handleCreateCategory);
            document.getElementById('addResourceForm').addEventListener('submit', handleAddResource);
            document.getElementById('editResourceForm').addEventListener('submit', handleEditResource);
        }
        
        // åŠ è½½æ–‡ä»¶å¤¹æ ‘
        async function loadFolderTree() {
            try {
                const response = await fetch('/academic/api/folders/tree', {
                    credentials: 'include'
                });
                const result = await response.json();
                
                if (result.success) {
                    folders = result.data;
                    console.log('æ–‡ä»¶å¤¹æ•°æ®:', folders);
                    displayFolderTree(folders);
                } else {
                    console.error('åŠ è½½æ–‡ä»¶å¤¹æ ‘å¤±è´¥:', result.message);
                }
            } catch (error) {
                console.error('åŠ è½½æ–‡ä»¶å¤¹æ ‘å¤±è´¥:', error);
            }
        }
        
        // æ˜¾ç¤ºæ–‡ä»¶å¤¹åˆ—è¡¨ï¼ˆç®€åŒ–ç‰ˆï¼Œæ— å±‚çº§ï¼‰
        function displayFolderTree(folderList) {
            const container = document.getElementById('folderTree');
            
            if (!folderList || folderList.length === 0) {
                container.innerHTML = '<div class="empty-state"><p>æš‚æ— æ–‡ä»¶å¤¹</p></div>';
                return;
            }
            
            // åªæ˜¾ç¤ºæ ¹çº§åˆ«çš„æ–‡ä»¶å¤¹ï¼Œå¿½ç•¥children
            const rootFolders = folderList.filter(folder => !folder.parent_id);
            
            const html = rootFolders.map(folder => `
                <div class="folder-item ${currentFolderId === folder.id ? 'active' : ''}" 
                     onclick="navigateToFolder(${folder.id})">
                    <span class="folder-icon">ğŸ“</span>
                    <span class="folder-name">${escapeHtml(folder.name)}</span>
                    <div class="folder-actions">
                        <button class="btn-icon" onclick="event.stopPropagation(); editFolder(${folder.id})" title="ç¼–è¾‘">âœï¸</button>
                        <button class="btn-icon" onclick="event.stopPropagation(); deleteFolder(${folder.id})" title="åˆ é™¤">ğŸ—‘ï¸</button>
                    </div>
                </div>
            `).join('');
            
            container.innerHTML = html;
        }
        
        // åŠ è½½åˆ†ç±»
        async function loadCategories() {
            try {
                const response = await fetch('/academic/api/categories', {
                    credentials: 'include'
                });
                const result = await response.json();
                
                if (result.success) {
                    categories = result.data;
                    updateCategorySelects();
                }
            } catch (error) {
                console.error('åŠ è½½åˆ†ç±»å¤±è´¥:', error);
            }
        }
        
        // æ›´æ–°åˆ†ç±»é€‰æ‹©æ¡†
        function updateCategorySelects() {
            const select = document.getElementById('resourceCategory');
            select.innerHTML = '<option value="">é€‰æ‹©åˆ†ç±»</option>';
            
            categories.forEach(category => {
                const option = document.createElement('option');
                option.value = category.id;
                option.textContent = category.name;
                select.appendChild(option);
            });
        }
        
        // åŠ è½½èµ„æº
        async function loadResources() {
            try {
                const container = document.getElementById('fileGrid');
                container.innerHTML = '<div class="loading">åŠ è½½ä¸­...</div>';
                
                const params = new URLSearchParams();
                if (currentFolderId !== null && currentFolderId !== undefined) {
                    params.append('folder_id', currentFolderId);
                }
                
                console.log('Loading resources for folder:', currentFolderId);
                console.log('API URL:', `/academic/api/resources?${params}`);
                
                const response = await fetch(`/academic/api/resources?${params}`, {
                    credentials: 'include'
                });
                const result = await response.json();
                
                console.log('Resources response:', result);
                
                if (result.success) {
                    displayResources(result.data.resources);
                } else {
                    container.innerHTML = '<div class="empty-state"><h3>åŠ è½½å¤±è´¥</h3><p>' + result.message + '</p></div>';
                }
            } catch (error) {
                console.error('åŠ è½½èµ„æºå¤±è´¥:', error);
                document.getElementById('fileGrid').innerHTML = 
                    '<div class="empty-state"><h3>åŠ è½½å¤±è´¥</h3><p>ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•</p></div>';
            }
        }
        
        // æ˜¾ç¤ºèµ„æº
        function displayResources(resources) {
            const container = document.getElementById('fileGrid');
            
            if (resources.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <h3>æš‚æ— æ–‡çŒ®</h3>
                        <p>å½“å‰æ–‡ä»¶å¤¹ä¸ºç©ºï¼Œç‚¹å‡»ä¸Šæ–¹æŒ‰é’®æ·»åŠ æ–‡çŒ®</p>
                    </div>
                `;
                return;
            }
            
            const html = resources.map(resource => {
                // æŸ¥æ‰¾æ–‡ä»¶å¤¹åç§°
                let folderName = '';
                if (resource.folder_id !== null && resource.folder_id !== undefined) {
                    const folder = findFolderById(folders, resource.folder_id);
                    folderName = folder ? folder.name : 'æœªçŸ¥æ–‡ä»¶å¤¹';
                }
                
                // æŸ¥æ‰¾åˆ†ç±»åç§°
                let categoryName = '';
                if (resource.user_category_id !== null && resource.user_category_id !== undefined) {
                    const category = categories.find(c => c.id === resource.user_category_id);
                    categoryName = category ? category.name : 'æœªçŸ¥åˆ†ç±»';
                }
                
                return `
                <div class="file-item" onclick="viewResource(${resource.id})">
                    <div class="file-icon">ğŸ“„</div>
                    <div class="file-name">${escapeHtml(resource.title)}</div>
                    <div class="file-meta">
                        ${resource.authors ? escapeHtml(resource.authors) : 'æœªçŸ¥ä½œè€…'} â€¢ 
                        ${resource.publication_year || 'æœªçŸ¥å¹´ä»½'}
                        ${folderName ? ` â€¢ ğŸ“ ${escapeHtml(folderName)}` : ''}
                        ${categoryName ? ` â€¢ ğŸ·ï¸ ${escapeHtml(categoryName)}` : ''}
                    </div>
                    <div class="file-actions">
                        ${resource.file_type === 'pdf' ? `
                            <button class="btn-icon" onclick="event.stopPropagation(); previewFile(${resource.id})" title="é¢„è§ˆ">ğŸ‘ï¸</button>
                        ` : ''}
                        <button class="btn-icon" onclick="event.stopPropagation(); downloadFile(${resource.id})" title="ä¸‹è½½">â¬‡ï¸</button>
                        <button class="btn-icon" onclick="event.stopPropagation(); editResource(${resource.id})" title="ç¼–è¾‘">âœï¸</button>
                        <button class="btn-icon" onclick="event.stopPropagation(); deleteResource(${resource.id})" title="åˆ é™¤">ğŸ—‘ï¸</button>
                    </div>
                </div>
            `;
            }).join('');
            
            container.innerHTML = html;
        }
        
        // å¯¼èˆªåˆ°æ–‡ä»¶å¤¹
        function navigateToFolder(folderId) {
            console.log('Navigating to folder:', folderId);
            currentFolderId = folderId;
            updateBreadcrumb(folderId);
            loadResources();
            // é‡æ–°åŠ è½½æ–‡ä»¶å¤¹æ ‘ä»¥æ›´æ–°æ´»åŠ¨çŠ¶æ€
            loadFolderTree();
        }
        
        // æ›´æ–°é¢åŒ…å±‘
        function updateBreadcrumb(folderId) {
            const breadcrumb = document.getElementById('breadcrumb');
            breadcrumb.innerHTML = '<span class="breadcrumb-item" onclick="navigateToFolder(null)">ğŸ“ æˆ‘çš„æ–‡çŒ®</span>';
            
            if (folderId) {
                // æ‰¾åˆ°æ–‡ä»¶å¤¹åç§°
                const folder = findFolderById(folders, folderId);
                const folderName = folder ? folder.name : 'æœªçŸ¥æ–‡ä»¶å¤¹';
                breadcrumb.innerHTML += '<span class="breadcrumb-separator">/</span><span class="breadcrumb-item">' + escapeHtml(folderName) + '</span>';
            }
        }
        
        // æ‰“å¼€åˆ›å»ºæ–‡ä»¶å¤¹æ¨¡æ€æ¡†
        function openCreateFolderModal() {
            document.getElementById('createFolderModal').style.display = 'block';
        }
        
        // æ‰“å¼€åˆ›å»ºåˆ†ç±»æ¨¡æ€æ¡†
        function openCreateCategoryModal() {
            document.getElementById('createCategoryModal').style.display = 'block';
        }
        
        // æ‰“å¼€æ·»åŠ æ–‡çŒ®æ¨¡æ€æ¡†
        function openAddResourceModal() {
            // æ›´æ–°æ–‡ä»¶å¤¹é€‰æ‹©æ¡†ï¼ˆåªæ˜¾ç¤ºæ ¹çº§åˆ«æ–‡ä»¶å¤¹ï¼‰
            const select = document.getElementById('resourceFolder');
            select.innerHTML = '<option value="">é€‰æ‹©æ–‡ä»¶å¤¹</option>';
            
            // åªæ˜¾ç¤ºæ ¹çº§åˆ«çš„æ–‡ä»¶å¤¹
            const rootFolders = folders.filter(folder => !folder.parent_id);
            rootFolders.forEach(folder => {
                const option = document.createElement('option');
                option.value = folder.id;
                option.textContent = folder.name;
                select.appendChild(option);
            });
            
            // å¦‚æœå½“å‰åœ¨æŸä¸ªæ–‡ä»¶å¤¹ä¸­ï¼Œé»˜è®¤é€‰æ‹©è¯¥æ–‡ä»¶å¤¹
            if (currentFolderId) {
                select.value = currentFolderId;
            }
            
            document.getElementById('addResourceModal').style.display = 'block';
        }
        
        // å…³é—­æ¨¡æ€æ¡†
        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }
        
        // å¤„ç†åˆ›å»ºæ–‡ä»¶å¤¹
        async function handleCreateFolder(event) {
            event.preventDefault();
            
            const formData = new FormData(event.target);
            const data = {
                name: formData.get('name'),
                description: formData.get('description'),
                color: formData.get('color'),
                parent_id: null  // æ‰€æœ‰æ–‡ä»¶å¤¹éƒ½åœ¨æ ¹çº§åˆ«
            };
            
            try {
                const response = await fetch('/academic/api/folders', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    closeModal('createFolderModal');
                    loadFolderTree();
                    alert('æ–‡ä»¶å¤¹åˆ›å»ºæˆåŠŸ');
                } else {
                    alert('åˆ›å»ºå¤±è´¥: ' + result.message);
                }
            } catch (error) {
                console.error('åˆ›å»ºæ–‡ä»¶å¤¹å¤±è´¥:', error);
                alert('åˆ›å»ºå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
            }
        }
        
        // å¤„ç†åˆ›å»ºåˆ†ç±»
        async function handleCreateCategory(event) {
            event.preventDefault();
            
            const formData = new FormData(event.target);
            const data = {
                name: formData.get('name'),
                description: formData.get('description'),
                color: formData.get('color')
            };
            
            try {
                const response = await fetch('/academic/api/categories', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    closeModal('createCategoryModal');
                    loadCategories();
                    alert('åˆ†ç±»åˆ›å»ºæˆåŠŸ');
                } else {
                    alert('åˆ›å»ºå¤±è´¥: ' + result.message);
                }
            } catch (error) {
                console.error('åˆ›å»ºåˆ†ç±»å¤±è´¥:', error);
                alert('åˆ›å»ºå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
            }
        }
        
        // å¤„ç†æ·»åŠ æ–‡çŒ®
        async function handleAddResource(event) {
            event.preventDefault();
            
            const formData = new FormData(event.target);
            
            try {
                const response = await fetch('/academic/api/resources', {
                    method: 'POST',
                    credentials: 'include',
                    body: formData
                });
                
                const result = await response.json();
                
                if (result.success) {
                    closeModal('addResourceModal');
                    loadResources();
                    alert('æ–‡çŒ®æ·»åŠ æˆåŠŸ');
                } else {
                    alert('æ·»åŠ å¤±è´¥: ' + result.message);
                }
            } catch (error) {
                console.error('æ·»åŠ æ–‡çŒ®å¤±è´¥:', error);
                alert('æ·»åŠ å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
            }
        }
        
        // å¤„ç†ç¼–è¾‘æ–‡çŒ®
        async function handleEditResource(event) {
            event.preventDefault();
            
            const formData = new FormData(event.target);
            const resourceId = formData.get('id');
            
            // å‡†å¤‡æ›´æ–°æ•°æ®
            const data = {
                title: formData.get('title'),
                authors: formData.get('authors'),
                subject: formData.get('subject'),
                publication_year: formData.get('publication_year') ? parseInt(formData.get('publication_year')) : null,
                keywords: formData.get('keywords') ? formData.get('keywords').split(',').map(k => k.trim()).filter(k => k) : [],
                reading_status: formData.get('reading_status'),
                abstract: formData.get('abstract'),
                notes: formData.get('notes'),
                folder_id: formData.get('folder_id') ? parseInt(formData.get('folder_id')) : null,
                user_category_id: formData.get('user_category_id') ? parseInt(formData.get('user_category_id')) : null
            };
            
            try {
                const response = await fetch(`/academic/api/resources/${resourceId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    closeModal('editResourceModal');
                    loadResources();
                    alert('æ–‡çŒ®æ›´æ–°æˆåŠŸ');
                } else {
                    alert('æ›´æ–°å¤±è´¥: ' + result.message);
                }
            } catch (error) {
                console.error('æ›´æ–°æ–‡çŒ®å¤±è´¥:', error);
                alert('æ›´æ–°å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
            }
        }
        
        // å·¥å…·å‡½æ•°
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
        window.onclick = function(event) {
            const modals = document.querySelectorAll('.modal');
            modals.forEach(modal => {
                if (event.target === modal) {
                    modal.style.display = 'none';
                }
            });
        }
        
        // ç¼–è¾‘æ–‡ä»¶å¤¹
        function editFolder(folderId) {
            // æ‰¾åˆ°è¦ç¼–è¾‘çš„æ–‡ä»¶å¤¹
            const folder = findFolderById(folders, folderId);
            if (!folder) {
                alert('æ–‡ä»¶å¤¹ä¸å­˜åœ¨');
                return;
            }
            
            // å¡«å……è¡¨å•
            document.getElementById('editFolderId').value = folder.id;
            document.getElementById('editFolderName').value = folder.name;
            document.getElementById('editFolderDescription').value = folder.description || '';
            document.getElementById('editFolderColor').value = folder.color || '#007bff';
            
            // æ˜¾ç¤ºæ¨¡æ€æ¡†
            document.getElementById('editFolderModal').style.display = 'block';
        }
        
        // åˆ é™¤æ–‡ä»¶å¤¹
        async function deleteFolder(folderId) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªæ–‡ä»¶å¤¹å—ï¼Ÿæ–‡ä»¶å¤¹å†…çš„æ–‡ä»¶å°†è¢«ç§»åŠ¨åˆ°çˆ¶æ–‡ä»¶å¤¹ã€‚')) {
                return;
            }
            
            try {
                const response = await fetch(`/academic/api/folders/${folderId}`, {
                    method: 'DELETE',
                    credentials: 'include'
                });
                
                const result = await response.json();
                
                if (result.success) {
                    loadFolderTree();
                    loadResources();
                    alert('æ–‡ä»¶å¤¹åˆ é™¤æˆåŠŸ');
                } else {
                    alert('åˆ é™¤å¤±è´¥: ' + result.message);
                }
            } catch (error) {
                console.error('åˆ é™¤æ–‡ä»¶å¤¹å¤±è´¥:', error);
                alert('åˆ é™¤å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
            }
        }
        
        // å¤„ç†ç¼–è¾‘æ–‡ä»¶å¤¹
        async function handleEditFolder(event) {
            event.preventDefault();
            
            const formData = new FormData(event.target);
            const folderId = formData.get('id');
            const data = {
                name: formData.get('name'),
                description: formData.get('description'),
                color: formData.get('color')
            };
            
            try {
                const response = await fetch(`/academic/api/folders/${folderId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    closeModal('editFolderModal');
                    loadFolderTree();
                    alert('æ–‡ä»¶å¤¹æ›´æ–°æˆåŠŸ');
                } else {
                    alert('æ›´æ–°å¤±è´¥: ' + result.message);
                }
            } catch (error) {
                console.error('æ›´æ–°æ–‡ä»¶å¤¹å¤±è´¥:', error);
                alert('æ›´æ–°å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
            }
        }
        
        // æŸ¥æ‰¾æ–‡ä»¶å¤¹ï¼ˆç®€åŒ–ç‰ˆï¼ŒåªæŸ¥æ‰¾æ ¹çº§åˆ«ï¼‰
        function findFolderById(folderList, id) {
            return folderList.find(folder => folder.id === id) || null;
        }
        
        // é¢„è§ˆæ–‡ä»¶
        function previewFile(resourceId) {
            window.open(`/academic/api/preview/${resourceId}`, '_blank');
        }
        
        // ä¸‹è½½æ–‡ä»¶
        function downloadFile(resourceId) {
            window.open(`/academic/api/download/${resourceId}`, '_blank');
        }
        
        // æŸ¥çœ‹èµ„æºè¯¦æƒ…
        function viewResource(resourceId) {
            // å¯ä»¥æ‰“å¼€ä¸€ä¸ªè¯¦æƒ…æ¨¡æ€æ¡†
            console.log('View resource:', resourceId);
        }
        
        // ç¼–è¾‘èµ„æº
        async function editResource(resourceId) {
            try {
                // è·å–èµ„æºè¯¦æƒ…
                const response = await fetch(`/academic/api/resources/${resourceId}`, {
                    credentials: 'include'
                });
                const result = await response.json();
                
                if (!result.success) {
                    alert('è·å–æ–‡çŒ®è¯¦æƒ…å¤±è´¥: ' + result.message);
                    return;
                }
                
                const resource = result.data;
                
                // å¡«å……ç¼–è¾‘è¡¨å•
                document.getElementById('editResourceId').value = resource.id;
                document.getElementById('editResourceTitle').value = resource.title || '';
                document.getElementById('editResourceAuthors').value = resource.authors || '';
                document.getElementById('editResourceSubject').value = resource.subject || '';
                document.getElementById('editResourceYear').value = resource.publication_year || '';
                document.getElementById('editResourceKeywords').value = resource.keywords ? resource.keywords.join(', ') : '';
                document.getElementById('editResourceStatus').value = resource.reading_status || 'unread';
                document.getElementById('editResourceAbstract').value = resource.abstract || '';
                document.getElementById('editResourceNotes').value = resource.notes || '';
                
                // æ›´æ–°æ–‡ä»¶å¤¹é€‰æ‹©æ¡†
                const folderSelect = document.getElementById('editResourceFolder');
                folderSelect.innerHTML = '<option value="">é€‰æ‹©æ–‡ä»¶å¤¹</option>';
                const rootFolders = folders.filter(folder => !folder.parent_id);
                rootFolders.forEach(folder => {
                    const option = document.createElement('option');
                    option.value = folder.id;
                    option.textContent = folder.name;
                    if (resource.folder_id === folder.id) {
                        option.selected = true;
                    }
                    folderSelect.appendChild(option);
                });
                
                // æ›´æ–°åˆ†ç±»é€‰æ‹©æ¡†
                const categorySelect = document.getElementById('editResourceCategory');
                categorySelect.innerHTML = '<option value="">é€‰æ‹©åˆ†ç±»</option>';
                categories.forEach(category => {
                    const option = document.createElement('option');
                    option.value = category.id;
                    option.textContent = category.name;
                    if (resource.user_category_id === category.id) {
                        option.selected = true;
                    }
                    categorySelect.appendChild(option);
                });
                
                // æ˜¾ç¤ºç¼–è¾‘æ¨¡æ€æ¡†
                document.getElementById('editResourceModal').style.display = 'block';
                
            } catch (error) {
                console.error('è·å–æ–‡çŒ®è¯¦æƒ…å¤±è´¥:', error);
                alert('è·å–æ–‡çŒ®è¯¦æƒ…å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
            }
        }
        
        // åˆ é™¤èµ„æº
        function deleteResource(resourceId) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªæ–‡çŒ®å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚')) {
                return;
            }
            
            fetch(`/academic/api/resources/${resourceId}`, {
                method: 'DELETE',
                credentials: 'include'
            })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    loadResources();
                    alert('æ–‡çŒ®åˆ é™¤æˆåŠŸ');
                } else {
                    alert('åˆ é™¤å¤±è´¥: ' + result.message);
                }
            })
            .catch(error => {
                console.error('åˆ é™¤æ–‡çŒ®å¤±è´¥:', error);
                alert('åˆ é™¤å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
            });
        }
        
        // å ä½å‡½æ•°ï¼ˆå¾…å®ç°ï¼‰
        function filterFolders() { /* TODO */ }
    </script>
</body>
</html>
