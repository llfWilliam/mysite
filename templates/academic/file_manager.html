<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Â≠¶ÊúØËµÑÊ∫êÂ∫ì - Êñá‰ª∂ÁÆ°ÁêÜÂô® - MySite</title>
    <link rel="stylesheet" href="/light.css">
    <link rel="stylesheet" href="/dark.css" id="dark-css" disabled>
    <style>
        .file-manager {
            display: flex;
            height: calc(100vh - 60px);
            background: var(--bg-color);
        }
        
        /* ‰æßËæπÊ†è */
        .sidebar {
            width: 300px;
            background: var(--card-bg);
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
        }
        
        .sidebar-header {
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .sidebar-title {
            font-size: 1.2rem;
            font-weight: bold;
            color: var(--text-color);
            margin-bottom: 15px;
        }
        
        .search-box {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            background: var(--bg-color);
            color: var(--text-color);
        }
        
        .folder-tree {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
        }
        
        .folder-item {
            display: flex;
            align-items: center;
            padding: 8px 12px;
            margin: 2px 0;
            border-radius: 4px;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .folder-item:hover {
            background: var(--hover-bg);
        }
        
        .folder-item.active {
            background: var(--primary-color);
            color: white;
        }
        
        .folder-icon {
            width: 16px;
            height: 16px;
            margin-right: 8px;
            color: var(--primary-color);
        }
        
        .folder-item.active .folder-icon {
            color: white;
        }
        
        .folder-name {
            flex: 1;
            font-size: 0.9rem;
        }
        
        .folder-actions {
            display: none;
            gap: 5px;
        }
        
        .folder-item:hover .folder-actions {
            display: flex;
        }
        
        .btn-icon {
            width: 20px;
            height: 20px;
            border: none;
            background: none;
            cursor: pointer;
            border-radius: 2px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-muted);
        }
        
        .btn-icon:hover {
            background: var(--hover-bg);
            color: var(--text-color);
        }
        
        /* ‰∏ªÂÜÖÂÆπÂå∫ */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        
        .toolbar {
            padding: 15px 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            gap: 15px;
            background: var(--card-bg);
        }
        
        .breadcrumb {
            flex: 1;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .breadcrumb-item {
            color: var(--text-muted);
            cursor: pointer;
        }
        
        .breadcrumb-item:hover {
            color: var(--text-color);
        }
        
        .breadcrumb-separator {
            color: var(--text-muted);
        }
        
        .toolbar-actions {
            display: flex;
            gap: 10px;
        }
        
        .btn {
            padding: 8px 16px;
            border: 1px solid var(--border-color);
            background: var(--bg-color);
            color: var(--text-color);
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s;
        }
        
        .btn:hover {
            background: var(--hover-bg);
        }
        
        .btn-primary {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }
        
        .btn-primary:hover {
            background: var(--primary-hover);
        }
        
        /* Êñá‰ª∂ÂàóË°® */
        .file-list {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }
        
        .file-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 20px;
        }
        
        .file-item {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }
        
        .file-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .file-icon {
            width: 40px;
            height: 40px;
            margin: 0 auto 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--primary-color);
            color: white;
            border-radius: 8px;
            font-size: 1.2rem;
        }
        
        .file-name {
            font-weight: 500;
            color: var(--text-color);
            margin-bottom: 5px;
            word-break: break-word;
        }
        
        .file-meta {
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-bottom: 10px;
        }
        
        .file-actions {
            display: none;
            position: absolute;
            top: 10px;
            right: 10px;
            gap: 5px;
        }
        
        .file-item:hover .file-actions {
            display: flex;
        }
        
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-muted);
        }
        
        .empty-state h3 {
            margin-bottom: 10px;
            color: var(--text-color);
        }
        
        /* Ê®°ÊÄÅÊ°Ü */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        
        .modal-content {
            background-color: var(--bg-color);
            margin: 2% auto;
            padding: 20px;
            border-radius: 8px;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .modal-title {
            font-size: 1.3rem;
            font-weight: bold;
            color: var(--text-color);
        }
        
        .close {
            color: var(--text-muted);
            font-size: 24px;
            font-weight: bold;
            cursor: pointer;
        }
        
        .close:hover {
            color: var(--text-color);
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: var(--text-color);
        }
        
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            background: var(--bg-color);
            color: var(--text-color);
        }
        
        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }
        
        .form-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 20px;
        }
        
        .btn-secondary {
            background: var(--text-muted);
            color: white;
            border: none;
        }
        
        .btn-secondary:hover {
            background: var(--text-color);
        }
        
        /* ÂìçÂ∫îÂºè */
        @media (max-width: 768px) {
            .file-manager {
                flex-direction: column;
                height: auto;
            }
            
            .sidebar {
                width: 100%;
                height: 200px;
            }
            
            .file-grid {
                grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
                gap: 15px;
            }
        }
    </style>
</head>
<body>
    <div class="file-manager">
        <!-- ‰æßËæπÊ†è -->
        <div class="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-title">üìÅ Êñá‰ª∂Â§π</div>
                <input type="text" class="search-box" id="folderSearch" placeholder="ÊêúÁ¥¢Êñá‰ª∂Â§π...">
            </div>
            <div class="folder-tree" id="folderTree">
                <div class="loading">Âä†ËΩΩ‰∏≠...</div>
            </div>
        </div>
        
        <!-- ‰∏ªÂÜÖÂÆπÂå∫ -->
        <div class="main-content">
            <!-- Â∑•ÂÖ∑Ê†è -->
            <div class="toolbar">
                <div class="breadcrumb" id="breadcrumb">
                    <span class="breadcrumb-item" onclick="navigateToFolder(null)">üìÅ ÊàëÁöÑÊñáÁåÆ</span>
                </div>
                <div class="toolbar-actions">
                    <button class="btn" onclick="openCreateFolderModal()">üìÅ Êñ∞Âª∫Êñá‰ª∂Â§π</button>
                    <button class="btn" onclick="openCreateCategoryModal()">üè∑Ô∏è Êñ∞Âª∫ÂàÜÁ±ª</button>
                    <button class="btn btn-primary" onclick="openAddResourceModal()">üìÑ Ê∑ªÂä†ÊñáÁåÆ</button>
                </div>
            </div>
            
            <!-- Êñá‰ª∂ÂàóË°® -->
            <div class="file-list">
                <div class="file-grid" id="fileGrid">
                    <div class="loading">Âä†ËΩΩ‰∏≠...</div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- ÂàõÂª∫Êñá‰ª∂Â§πÊ®°ÊÄÅÊ°Ü -->
    <div id="createFolderModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">ÂàõÂª∫Êñá‰ª∂Â§π</h2>
                <span class="close" onclick="closeModal('createFolderModal')">&times;</span>
            </div>
            <form id="createFolderForm">
                <div class="form-group">
                    <label for="folderName">Êñá‰ª∂Â§πÂêçÁß∞ *</label>
                    <input type="text" id="folderName" name="name" required>
                </div>
                <div class="form-group">
                    <label for="folderDescription">ÊèèËø∞</label>
                    <textarea id="folderDescription" name="description"></textarea>
                </div>
                <div class="form-group">
                    <label for="folderColor">È¢úËâ≤</label>
                    <input type="color" id="folderColor" name="color" value="#007bff">
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('createFolderModal')">ÂèñÊ∂à</button>
                    <button type="submit" class="btn btn-primary">ÂàõÂª∫</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- ÂàõÂª∫ÂàÜÁ±ªÊ®°ÊÄÅÊ°Ü -->
    <div id="createCategoryModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">ÂàõÂª∫ÂàÜÁ±ª</h2>
                <span class="close" onclick="closeModal('createCategoryModal')">&times;</span>
            </div>
            <form id="createCategoryForm">
                <div class="form-group">
                    <label for="categoryName">ÂàÜÁ±ªÂêçÁß∞ *</label>
                    <input type="text" id="categoryName" name="name" required>
                </div>
                <div class="form-group">
                    <label for="categoryDescription">ÊèèËø∞</label>
                    <textarea id="categoryDescription" name="description"></textarea>
                </div>
                <div class="form-group">
                    <label for="categoryColor">È¢úËâ≤</label>
                    <input type="color" id="categoryColor" name="color" value="#6c757d">
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('createCategoryModal')">ÂèñÊ∂à</button>
                    <button type="submit" class="btn btn-primary">ÂàõÂª∫</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Ê∑ªÂä†ÊñáÁåÆÊ®°ÊÄÅÊ°Ü -->
    <div id="addResourceModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Ê∑ªÂä†ÊñáÁåÆ</h2>
                <span class="close" onclick="closeModal('addResourceModal')">&times;</span>
            </div>
            <form id="addResourceForm" enctype="multipart/form-data">
                <div class="form-group">
                    <label for="resourceTitle">Ê†áÈ¢ò *</label>
                    <input type="text" id="resourceTitle" name="title" required>
                </div>
                <div class="form-group">
                    <label for="resourceAuthors">‰ΩúËÄÖ</label>
                    <input type="text" id="resourceAuthors" name="authors" placeholder="Â§ö‰∏™‰ΩúËÄÖÁî®ÈÄóÂè∑ÂàÜÈöî">
                </div>
                <div class="form-group">
                    <label for="resourceFolder">Êñá‰ª∂Â§π</label>
                    <select id="resourceFolder" name="folder_id">
                        <option value="">ÈÄâÊã©Êñá‰ª∂Â§π</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="resourceCategory">ÂàÜÁ±ª</label>
                    <select id="resourceCategory" name="user_category_id">
                        <option value="">ÈÄâÊã©ÂàÜÁ±ª</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="resourceFile">Êñá‰ª∂</label>
                    <input type="file" id="resourceFile" name="file" accept=".pdf,.doc,.docx,.txt">
                </div>
                <div class="form-group">
                    <label for="resourceAbstract">ÊëòË¶Å</label>
                    <textarea id="resourceAbstract" name="abstract"></textarea>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('addResourceModal')">ÂèñÊ∂à</button>
                    <button type="submit" class="btn btn-primary">Ê∑ªÂä†</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- ÁºñËæëÊñá‰ª∂Â§πÊ®°ÊÄÅÊ°Ü -->
    <div id="editFolderModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">ÁºñËæëÊñá‰ª∂Â§π</h2>
                <span class="close" onclick="closeModal('editFolderModal')">&times;</span>
            </div>
            <form id="editFolderForm">
                <input type="hidden" id="editFolderId" name="id">
                <div class="form-group">
                    <label for="editFolderName">Êñá‰ª∂Â§πÂêçÁß∞ *</label>
                    <input type="text" id="editFolderName" name="name" required>
                </div>
                <div class="form-group">
                    <label for="editFolderDescription">ÊèèËø∞</label>
                    <textarea id="editFolderDescription" name="description"></textarea>
                </div>
                <div class="form-group">
                    <label for="editFolderColor">È¢úËâ≤</label>
                    <input type="color" id="editFolderColor" name="color" value="#007bff">
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('editFolderModal')">ÂèñÊ∂à</button>
                    <button type="submit" class="btn btn-primary">‰øùÂ≠ò</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- ÁºñËæëÊñáÁåÆÊ®°ÊÄÅÊ°Ü -->
    <div id="editResourceModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">ÁºñËæëÊñáÁåÆ</h2>
                <span class="close" onclick="closeModal('editResourceModal')">&times;</span>
            </div>
            <form id="editResourceForm">
                <input type="hidden" id="editResourceId" name="id">
                <div class="form-group">
                    <label for="editResourceTitle">Ê†áÈ¢ò *</label>
                    <input type="text" id="editResourceTitle" name="title" required>
                </div>
                <div class="form-group">
                    <label for="editResourceAuthors">‰ΩúËÄÖ</label>
                    <input type="text" id="editResourceAuthors" name="authors" placeholder="Â§ö‰∏™‰ΩúËÄÖÁî®ÈÄóÂè∑ÂàÜÈöî">
                </div>
                <div class="form-group">
                    <label for="editResourceFolder">Êñá‰ª∂Â§π</label>
                    <select id="editResourceFolder" name="folder_id">
                        <option value="">ÈÄâÊã©Êñá‰ª∂Â§π</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="editResourceCategory">ÂàÜÁ±ª</label>
                    <select id="editResourceCategory" name="user_category_id">
                        <option value="">ÈÄâÊã©ÂàÜÁ±ª</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="editResourceSubject">Â≠¶Áßë</label>
                    <input type="text" id="editResourceSubject" name="subject" placeholder="Â≠¶ÁßëÂàÜÁ±ª">
                </div>
                <div class="form-group">
                    <label for="editResourceYear">ÂèëË°®Âπ¥‰ªΩ</label>
                    <input type="number" id="editResourceYear" name="publication_year" min="1900" max="2030">
                </div>
                <div class="form-group">
                    <label for="editResourceKeywords">ÂÖ≥ÈîÆËØç</label>
                    <input type="text" id="editResourceKeywords" name="keywords" placeholder="Â§ö‰∏™ÂÖ≥ÈîÆËØçÁî®ÈÄóÂè∑ÂàÜÈöî">
                </div>
                <div class="form-group">
                    <label for="editResourceStatus">ÈòÖËØªÁä∂ÊÄÅ</label>
                    <select id="editResourceStatus" name="reading_status">
                        <option value="unread">Êú™ËØª</option>
                        <option value="reading">ÈòÖËØª‰∏≠</option>
                        <option value="completed">Â∑≤ÂÆåÊàê</option>
                        <option value="reviewing">Â§ç‰π†‰∏≠</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="editResourceAbstract">ÊëòË¶Å</label>
                    <textarea id="editResourceAbstract" name="abstract" rows="4"></textarea>
                </div>
                <div class="form-group">
                    <label for="editResourceNotes">‰∏™‰∫∫Á¨îËÆ∞</label>
                    <textarea id="editResourceNotes" name="notes" rows="3"></textarea>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('editResourceModal')">ÂèñÊ∂à</button>
                    <button type="submit" class="btn btn-primary">‰øùÂ≠ò</button>
                </div>
            </form>
        </div>
    </div>
    
    <script src="/theme.js"></script>
    <script>
        // ÂÖ®Â±ÄÂèòÈáè
        let currentFolderId = null;
        let folders = [];
        let categories = [];
        
        // È°µÈù¢Âä†ËΩΩÂÆåÊàêÂêéÂàùÂßãÂåñ
        document.addEventListener('DOMContentLoaded', function() {
            loadFolderTree();
            loadCategories();
            loadResources();
            setupEventListeners();
        });
        
        // ËÆæÁΩÆ‰∫ã‰ª∂ÁõëÂê¨Âô®
        function setupEventListeners() {
            // Êñá‰ª∂Â§πÊêúÁ¥¢
            document.getElementById('folderSearch').addEventListener('input', filterFolders);
            
            // Ë°®ÂçïÊèê‰∫§
            document.getElementById('createFolderForm').addEventListener('submit', handleCreateFolder);
            document.getElementById('editFolderForm').addEventListener('submit', handleEditFolder);
            document.getElementById('createCategoryForm').addEventListener('submit', handleCreateCategory);
            document.getElementById('addResourceForm').addEventListener('submit', handleAddResource);
            document.getElementById('editResourceForm').addEventListener('submit', handleEditResource);
        }
        
        // Âä†ËΩΩÊñá‰ª∂Â§πÊ†ë
        async function loadFolderTree() {
            try {
                const response = await fetch('/academic/api/folders/tree', {
                    credentials: 'include'
                });
                const result = await response.json();
                
                if (result.success) {
                    folders = result.data;
                    console.log('Êñá‰ª∂Â§πÊï∞ÊçÆ:', folders);
                    displayFolderTree(folders);
                } else {
                    console.error('Âä†ËΩΩÊñá‰ª∂Â§πÊ†ëÂ§±Ë¥•:', result.message);
                }
            } catch (error) {
                console.error('Âä†ËΩΩÊñá‰ª∂Â§πÊ†ëÂ§±Ë¥•:', error);
            }
        }
        
        // ÊòæÁ§∫Êñá‰ª∂Â§πÂàóË°®ÔºàÁÆÄÂåñÁâàÔºåÊó†Â±ÇÁ∫ßÔºâ
        function displayFolderTree(folderList) {
            const container = document.getElementById('folderTree');
            
            if (!folderList || folderList.length === 0) {
                container.innerHTML = '<div class="empty-state"><p>ÊöÇÊó†Êñá‰ª∂Â§π</p></div>';
                return;
            }
            
            // Âè™ÊòæÁ§∫Ê†πÁ∫ßÂà´ÁöÑÊñá‰ª∂Â§πÔºåÂøΩÁï•children
            const rootFolders = folderList.filter(folder => !folder.parent_id);
            
            const html = rootFolders.map(folder => `
                <div class="folder-item ${currentFolderId === folder.id ? 'active' : ''}" 
                     onclick="navigateToFolder(${folder.id})">
                    <span class="folder-icon">üìÅ</span>
                    <span class="folder-name">${escapeHtml(folder.name)}</span>
                    <div class="folder-actions">
                        <button class="btn-icon" onclick="event.stopPropagation(); editFolder(${folder.id})" title="ÁºñËæë">‚úèÔ∏è</button>
                        <button class="btn-icon" onclick="event.stopPropagation(); deleteFolder(${folder.id})" title="Âà†Èô§">üóëÔ∏è</button>
                    </div>
                </div>
            `).join('');
            
            container.innerHTML = html;
        }
        
        // Âä†ËΩΩÂàÜÁ±ª
        async function loadCategories() {
            try {
                const response = await fetch('/academic/api/categories', {
                    credentials: 'include'
                });
                const result = await response.json();
                
                if (result.success) {
                    categories = result.data;
                    updateCategorySelects();
                }
            } catch (error) {
                console.error('Âä†ËΩΩÂàÜÁ±ªÂ§±Ë¥•:', error);
            }
        }
        
        // Êõ¥Êñ∞ÂàÜÁ±ªÈÄâÊã©Ê°Ü
        function updateCategorySelects() {
            const select = document.getElementById('resourceCategory');
            select.innerHTML = '<option value="">ÈÄâÊã©ÂàÜÁ±ª</option>';
            
            categories.forEach(category => {
                const option = document.createElement('option');
                option.value = category.id;
                option.textContent = category.name;
                select.appendChild(option);
            });
        }
        
        // Âä†ËΩΩËµÑÊ∫ê
        async function loadResources() {
            try {
                const container = document.getElementById('fileGrid');
                container.innerHTML = '<div class="loading">Âä†ËΩΩ‰∏≠...</div>';
                
                const params = new URLSearchParams();
                if (currentFolderId !== null && currentFolderId !== undefined) {
                    params.append('folder_id', currentFolderId);
                }
                
                console.log('Loading resources for folder:', currentFolderId);
                console.log('API URL:', `/academic/api/resources?${params}`);
                
                const response = await fetch(`/academic/api/resources?${params}`, {
                    credentials: 'include'
                });
                const result = await response.json();
                
                console.log('Resources response:', result);
                
                if (result.success) {
                    displayResources(result.data.resources);
                } else {
                    container.innerHTML = '<div class="empty-state"><h3>Âä†ËΩΩÂ§±Ë¥•</h3><p>' + result.message + '</p></div>';
                }
            } catch (error) {
                console.error('Âä†ËΩΩËµÑÊ∫êÂ§±Ë¥•:', error);
                document.getElementById('fileGrid').innerHTML = 
                    '<div class="empty-state"><h3>Âä†ËΩΩÂ§±Ë¥•</h3><p>ÁΩëÁªúÈîôËØØÔºåËØ∑Á®çÂêéÈáçËØï</p></div>';
            }
        }
        
        // ÊòæÁ§∫ËµÑÊ∫ê
        function displayResources(resources) {
            const container = document.getElementById('fileGrid');
            
            if (resources.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <h3>ÊöÇÊó†ÊñáÁåÆ</h3>
                        <p>ÂΩìÂâçÊñá‰ª∂Â§π‰∏∫Á©∫ÔºåÁÇπÂáª‰∏äÊñπÊåâÈíÆÊ∑ªÂä†ÊñáÁåÆ</p>
                    </div>
                `;
                return;
            }
            
            const html = resources.map(resource => {
                // Êü•ÊâæÊñá‰ª∂Â§πÂêçÁß∞
                let folderName = '';
                if (resource.folder_id !== null && resource.folder_id !== undefined) {
                    const folder = findFolderById(folders, resource.folder_id);
                    folderName = folder ? folder.name : 'Êú™Áü•Êñá‰ª∂Â§π';
                }
                
                // Êü•ÊâæÂàÜÁ±ªÂêçÁß∞
                let categoryName = '';
                if (resource.user_category_id !== null && resource.user_category_id !== undefined) {
                    const category = categories.find(c => c.id === resource.user_category_id);
                    categoryName = category ? category.name : 'Êú™Áü•ÂàÜÁ±ª';
                }
                
                return `
                <div class="file-item" onclick="viewResource(${resource.id})">
                    <div class="file-icon">üìÑ</div>
                    <div class="file-name">${escapeHtml(resource.title)}</div>
                    <div class="file-meta">
                        ${resource.authors ? escapeHtml(resource.authors) : 'Êú™Áü•‰ΩúËÄÖ'} ‚Ä¢ 
                        ${resource.publication_year || 'Êú™Áü•Âπ¥‰ªΩ'}
                        ${folderName ? ` ‚Ä¢ üìÅ ${escapeHtml(folderName)}` : ''}
                        ${categoryName ? ` ‚Ä¢ üè∑Ô∏è ${escapeHtml(categoryName)}` : ''}
                    </div>
                    <div class="file-actions">
                        ${resource.file_type === 'pdf' ? `
                            <button class="btn-icon" onclick="event.stopPropagation(); previewFile(${resource.id})" title="È¢ÑËßà">üëÅÔ∏è</button>
                        ` : ''}
                        <button class="btn-icon" onclick="event.stopPropagation(); downloadFile(${resource.id})" title="‰∏ãËΩΩ">‚¨áÔ∏è</button>
                        <button class="btn-icon" onclick="event.stopPropagation(); editResource(${resource.id})" title="ÁºñËæë">‚úèÔ∏è</button>
                        <button class="btn-icon" onclick="event.stopPropagation(); deleteResource(${resource.id})" title="Âà†Èô§">üóëÔ∏è</button>
                    </div>
                </div>
            `;
            }).join('');
            
            container.innerHTML = html;
        }
        
        // ÂØºËà™Âà∞Êñá‰ª∂Â§π
        function navigateToFolder(folderId) {
            console.log('Navigating to folder:', folderId);
            currentFolderId = folderId;
            updateBreadcrumb(folderId);
            loadResources();
            // ÈáçÊñ∞Âä†ËΩΩÊñá‰ª∂Â§πÊ†ë‰ª•Êõ¥Êñ∞Ê¥ªÂä®Áä∂ÊÄÅ
            loadFolderTree();
        }
        
        // Êõ¥Êñ∞Èù¢ÂåÖÂ±ë
        function updateBreadcrumb(folderId) {
            const breadcrumb = document.getElementById('breadcrumb');
            breadcrumb.innerHTML = '<span class="breadcrumb-item" onclick="navigateToFolder(null)">üìÅ ÊàëÁöÑÊñáÁåÆ</span>';
            
            if (folderId) {
                // ÊâæÂà∞Êñá‰ª∂Â§πÂêçÁß∞
                const folder = findFolderById(folders, folderId);
                const folderName = folder ? folder.name : 'Êú™Áü•Êñá‰ª∂Â§π';
                breadcrumb.innerHTML += '<span class="breadcrumb-separator">/</span><span class="breadcrumb-item">' + escapeHtml(folderName) + '</span>';
            }
        }
        
        // ÊâìÂºÄÂàõÂª∫Êñá‰ª∂Â§πÊ®°ÊÄÅÊ°Ü
        function openCreateFolderModal() {
            document.getElementById('createFolderModal').style.display = 'block';
        }
        
        // ÊâìÂºÄÂàõÂª∫ÂàÜÁ±ªÊ®°ÊÄÅÊ°Ü
        function openCreateCategoryModal() {
            document.getElementById('createCategoryModal').style.display = 'block';
        }
        
        // ÊâìÂºÄÊ∑ªÂä†ÊñáÁåÆÊ®°ÊÄÅÊ°Ü
        function openAddResourceModal() {
            // Êõ¥Êñ∞Êñá‰ª∂Â§πÈÄâÊã©Ê°ÜÔºàÂè™ÊòæÁ§∫Ê†πÁ∫ßÂà´Êñá‰ª∂Â§πÔºâ
            const select = document.getElementById('resourceFolder');
            select.innerHTML = '<option value="">ÈÄâÊã©Êñá‰ª∂Â§π</option>';
            
            // Âè™ÊòæÁ§∫Ê†πÁ∫ßÂà´ÁöÑÊñá‰ª∂Â§π
            const rootFolders = folders.filter(folder => !folder.parent_id);
            rootFolders.forEach(folder => {
                const option = document.createElement('option');
                option.value = folder.id;
                option.textContent = folder.name;
                select.appendChild(option);
            });
            
            // Â¶ÇÊûúÂΩìÂâçÂú®Êüê‰∏™Êñá‰ª∂Â§π‰∏≠ÔºåÈªòËÆ§ÈÄâÊã©ËØ•Êñá‰ª∂Â§π
            if (currentFolderId) {
                select.value = currentFolderId;
            }
            
            document.getElementById('addResourceModal').style.display = 'block';
        }
        
        // ÂÖ≥Èó≠Ê®°ÊÄÅÊ°Ü
        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }
        
        // Â§ÑÁêÜÂàõÂª∫Êñá‰ª∂Â§π
        async function handleCreateFolder(event) {
            event.preventDefault();
            
            const formData = new FormData(event.target);
            const data = {
                name: formData.get('name'),
                description: formData.get('description'),
                color: formData.get('color'),
                parent_id: null  // ÊâÄÊúâÊñá‰ª∂Â§πÈÉΩÂú®Ê†πÁ∫ßÂà´
            };
            
            try {
                const response = await fetch('/academic/api/folders', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    closeModal('createFolderModal');
                    loadFolderTree();
                    alert('Êñá‰ª∂Â§πÂàõÂª∫ÊàêÂäü');
                } else {
                    alert('ÂàõÂª∫Â§±Ë¥•: ' + result.message);
                }
            } catch (error) {
                console.error('ÂàõÂª∫Êñá‰ª∂Â§πÂ§±Ë¥•:', error);
                alert('ÂàõÂª∫Â§±Ë¥•ÔºåËØ∑Á®çÂêéÈáçËØï');
            }
        }
        
        // Â§ÑÁêÜÂàõÂª∫ÂàÜÁ±ª
        async function handleCreateCategory(event) {
            event.preventDefault();
            
            const formData = new FormData(event.target);
            const data = {
                name: formData.get('name'),
                description: formData.get('description'),
                color: formData.get('color')
            };
            
            try {
                const response = await fetch('/academic/api/categories', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    closeModal('createCategoryModal');
                    loadCategories();
                    alert('ÂàÜÁ±ªÂàõÂª∫ÊàêÂäü');
                } else {
                    alert('ÂàõÂª∫Â§±Ë¥•: ' + result.message);
                }
            } catch (error) {
                console.error('ÂàõÂª∫ÂàÜÁ±ªÂ§±Ë¥•:', error);
                alert('ÂàõÂª∫Â§±Ë¥•ÔºåËØ∑Á®çÂêéÈáçËØï');
            }
        }
        
        // Â§ÑÁêÜÊ∑ªÂä†ÊñáÁåÆ
        async function handleAddResource(event) {
            event.preventDefault();
            
            const formData = new FormData(event.target);
            
            try {
                const response = await fetch('/academic/api/resources', {
                    method: 'POST',
                    credentials: 'include',
                    body: formData
                });
                
                const result = await response.json();
                
                if (result.success) {
                    closeModal('addResourceModal');
                    loadResources();
                    alert('ÊñáÁåÆÊ∑ªÂä†ÊàêÂäü');
                } else {
                    alert('Ê∑ªÂä†Â§±Ë¥•: ' + result.message);
                }
            } catch (error) {
                console.error('Ê∑ªÂä†ÊñáÁåÆÂ§±Ë¥•:', error);
                alert('Ê∑ªÂä†Â§±Ë¥•ÔºåËØ∑Á®çÂêéÈáçËØï');
            }
        }
        
        // Â§ÑÁêÜÁºñËæëÊñáÁåÆ
        async function handleEditResource(event) {
            event.preventDefault();
            
            const formData = new FormData(event.target);
            const resourceId = formData.get('id');
            
            // ÂáÜÂ§áÊõ¥Êñ∞Êï∞ÊçÆ
            const data = {
                title: formData.get('title'),
                authors: formData.get('authors'),
                subject: formData.get('subject'),
                publication_year: formData.get('publication_year') ? parseInt(formData.get('publication_year')) : null,
                keywords: formData.get('keywords') ? formData.get('keywords').split(',').map(k => k.trim()).filter(k => k) : [],
                reading_status: formData.get('reading_status'),
                abstract: formData.get('abstract'),
                notes: formData.get('notes'),
                folder_id: formData.get('folder_id') ? parseInt(formData.get('folder_id')) : null,
                user_category_id: formData.get('user_category_id') ? parseInt(formData.get('user_category_id')) : null
            };
            
            try {
                const response = await fetch(`/academic/api/resources/${resourceId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    closeModal('editResourceModal');
                    loadResources();
                    alert('ÊñáÁåÆÊõ¥Êñ∞ÊàêÂäü');
                } else {
                    alert('Êõ¥Êñ∞Â§±Ë¥•: ' + result.message);
                }
            } catch (error) {
                console.error('Êõ¥Êñ∞ÊñáÁåÆÂ§±Ë¥•:', error);
                alert('Êõ¥Êñ∞Â§±Ë¥•ÔºåËØ∑Á®çÂêéÈáçËØï');
            }
        }
        
        // Â∑•ÂÖ∑ÂáΩÊï∞
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // ÁÇπÂáªÊ®°ÊÄÅÊ°ÜÂ§ñÈÉ®ÂÖ≥Èó≠
        window.onclick = function(event) {
            const modals = document.querySelectorAll('.modal');
            modals.forEach(modal => {
                if (event.target === modal) {
                    modal.style.display = 'none';
                }
            });
        }
        
        // ÁºñËæëÊñá‰ª∂Â§π
        function editFolder(folderId) {
            // ÊâæÂà∞Ë¶ÅÁºñËæëÁöÑÊñá‰ª∂Â§π
            const folder = findFolderById(folders, folderId);
            if (!folder) {
                alert('Êñá‰ª∂Â§π‰∏çÂ≠òÂú®');
                return;
            }
            
            // Â°´ÂÖÖË°®Âçï
            document.getElementById('editFolderId').value = folder.id;
            document.getElementById('editFolderName').value = folder.name;
            document.getElementById('editFolderDescription').value = folder.description || '';
            document.getElementById('editFolderColor').value = folder.color || '#007bff';
            
            // ÊòæÁ§∫Ê®°ÊÄÅÊ°Ü
            document.getElementById('editFolderModal').style.display = 'block';
        }
        
        // Âà†Èô§Êñá‰ª∂Â§π
        async function deleteFolder(folderId) {
            if (!confirm('Á°ÆÂÆöË¶ÅÂà†Èô§Ëøô‰∏™Êñá‰ª∂Â§πÂêóÔºüÊñá‰ª∂Â§πÂÜÖÁöÑÊñá‰ª∂Â∞ÜË¢´ÁßªÂä®Âà∞Áà∂Êñá‰ª∂Â§π„ÄÇ')) {
                return;
            }
            
            try {
                const response = await fetch(`/academic/api/folders/${folderId}`, {
                    method: 'DELETE',
                    credentials: 'include'
                });
                
                const result = await response.json();
                
                if (result.success) {
                    loadFolderTree();
                    loadResources();
                    alert('Êñá‰ª∂Â§πÂà†Èô§ÊàêÂäü');
                } else {
                    alert('Âà†Èô§Â§±Ë¥•: ' + result.message);
                }
            } catch (error) {
                console.error('Âà†Èô§Êñá‰ª∂Â§πÂ§±Ë¥•:', error);
                alert('Âà†Èô§Â§±Ë¥•ÔºåËØ∑Á®çÂêéÈáçËØï');
            }
        }
        
        // Â§ÑÁêÜÁºñËæëÊñá‰ª∂Â§π
        async function handleEditFolder(event) {
            event.preventDefault();
            
            const formData = new FormData(event.target);
            const folderId = formData.get('id');
            const data = {
                name: formData.get('name'),
                description: formData.get('description'),
                color: formData.get('color')
            };
            
            try {
                const response = await fetch(`/academic/api/folders/${folderId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    closeModal('editFolderModal');
                    loadFolderTree();
                    alert('Êñá‰ª∂Â§πÊõ¥Êñ∞ÊàêÂäü');
                } else {
                    alert('Êõ¥Êñ∞Â§±Ë¥•: ' + result.message);
                }
            } catch (error) {
                console.error('Êõ¥Êñ∞Êñá‰ª∂Â§πÂ§±Ë¥•:', error);
                alert('Êõ¥Êñ∞Â§±Ë¥•ÔºåËØ∑Á®çÂêéÈáçËØï');
            }
        }
        
        // Êü•ÊâæÊñá‰ª∂Â§πÔºàÁÆÄÂåñÁâàÔºåÂè™Êü•ÊâæÊ†πÁ∫ßÂà´Ôºâ
        function findFolderById(folderList, id) {
            return folderList.find(folder => folder.id === id) || null;
        }
        
        // È¢ÑËßàÊñá‰ª∂
        function previewFile(resourceId) {
            window.open(`/academic/api/preview/${resourceId}`, '_blank');
        }
        
        // ‰∏ãËΩΩÊñá‰ª∂
        function downloadFile(resourceId) {
            window.open(`/academic/api/download/${resourceId}`, '_blank');
        }
        
        // Êü•ÁúãËµÑÊ∫êËØ¶ÊÉÖ
        function viewResource(resourceId) {
            // ÂèØ‰ª•ÊâìÂºÄ‰∏Ä‰∏™ËØ¶ÊÉÖÊ®°ÊÄÅÊ°Ü
            console.log('View resource:', resourceId);
        }
        
        // ÁºñËæëËµÑÊ∫ê
        async function editResource(resourceId) {
            try {
                // Ëé∑ÂèñËµÑÊ∫êËØ¶ÊÉÖ
                const response = await fetch(`/academic/api/resources/${resourceId}`, {
                    credentials: 'include'
                });
                const result = await response.json();
                
                if (!result.success) {
                    alert('Ëé∑ÂèñÊñáÁåÆËØ¶ÊÉÖÂ§±Ë¥•: ' + result.message);
                    return;
                }
                
                const resource = result.data;
                
                // Â°´ÂÖÖÁºñËæëË°®Âçï
                document.getElementById('editResourceId').value = resource.id;
                document.getElementById('editResourceTitle').value = resource.title || '';
                document.getElementById('editResourceAuthors').value = resource.authors || '';
                document.getElementById('editResourceSubject').value = resource.subject || '';
                document.getElementById('editResourceYear').value = resource.publication_year || '';
                document.getElementById('editResourceKeywords').value = resource.keywords ? resource.keywords.join(', ') : '';
                document.getElementById('editResourceStatus').value = resource.reading_status || 'unread';
                document.getElementById('editResourceAbstract').value = resource.abstract || '';
                document.getElementById('editResourceNotes').value = resource.notes || '';
                
                // Êõ¥Êñ∞Êñá‰ª∂Â§πÈÄâÊã©Ê°Ü
                const folderSelect = document.getElementById('editResourceFolder');
                folderSelect.innerHTML = '<option value="">ÈÄâÊã©Êñá‰ª∂Â§π</option>';
                const rootFolders = folders.filter(folder => !folder.parent_id);
                rootFolders.forEach(folder => {
                    const option = document.createElement('option');
                    option.value = folder.id;
                    option.textContent = folder.name;
                    if (resource.folder_id === folder.id) {
                        option.selected = true;
                    }
                    folderSelect.appendChild(option);
                });
                
                // Êõ¥Êñ∞ÂàÜÁ±ªÈÄâÊã©Ê°Ü
                const categorySelect = document.getElementById('editResourceCategory');
                categorySelect.innerHTML = '<option value="">ÈÄâÊã©ÂàÜÁ±ª</option>';
                categories.forEach(category => {
                    const option = document.createElement('option');
                    option.value = category.id;
                    option.textContent = category.name;
                    if (resource.user_category_id === category.id) {
                        option.selected = true;
                    }
                    categorySelect.appendChild(option);
                });
                
                // ÊòæÁ§∫ÁºñËæëÊ®°ÊÄÅÊ°Ü
                document.getElementById('editResourceModal').style.display = 'block';
                
            } catch (error) {
                console.error('Ëé∑ÂèñÊñáÁåÆËØ¶ÊÉÖÂ§±Ë¥•:', error);
                alert('Ëé∑ÂèñÊñáÁåÆËØ¶ÊÉÖÂ§±Ë¥•ÔºåËØ∑Á®çÂêéÈáçËØï');
            }
        }
        
        // Âà†Èô§ËµÑÊ∫ê
        function deleteResource(resourceId) {
            if (!confirm('Á°ÆÂÆöË¶ÅÂà†Èô§Ëøô‰∏™ÊñáÁåÆÂêóÔºüÊ≠§Êìç‰Ωú‰∏çÂèØÊÅ¢Â§ç„ÄÇ')) {
                return;
            }
            
            fetch(`/academic/api/resources/${resourceId}`, {
                method: 'DELETE',
                credentials: 'include'
            })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    loadResources();
                    alert('ÊñáÁåÆÂà†Èô§ÊàêÂäü');
                } else {
                    alert('Âà†Èô§Â§±Ë¥•: ' + result.message);
                }
            })
            .catch(error => {
                console.error('Âà†Èô§ÊñáÁåÆÂ§±Ë¥•:', error);
                alert('Âà†Èô§Â§±Ë¥•ÔºåËØ∑Á®çÂêéÈáçËØï');
            });
        }
        
        // Âç†‰ΩçÂáΩÊï∞ÔºàÂæÖÂÆûÁé∞Ôºâ
        function filterFolders() { /* TODO */ }
    </script>
</body>
</html>
